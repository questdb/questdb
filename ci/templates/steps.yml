steps:
  - checkout: self
    fetchDepth: 1
    lfs: false
    submodules: false
  - bash: sudo sysctl -w fs.file-max=500000
    displayName: "Increase file count on Linux"
    condition: eq(variables['os'], 'Linux')
  - task: Cache@2
    inputs:
      key: '"questdb_main" | "maven"'
      restoreKeys: |
      path: $(MAVEN_CACHE_FOLDER)
  - task: Maven@3
    displayName: "Compile with Maven"
    inputs:
      mavenPomFile: "pom.xml"
      mavenOptions: "$(MAVEN_OPTS)"
      options:
        "compile -DskipTests -P build-web-console
        -Dhttp.keepAlive=false"
      jdkVersionOption: $(jdk)
    condition: or(eq(variables['SOURCE_CODE_CHANGED'], 'false'), eq(variables['testset'], 'none'))
  - task: Maven@3
    displayName: "Run all tests"
    inputs:
      mavenPomFile: "core/pom.xml"
      mavenOptions: "$(MAVEN_OPTS)"
      goals: "test"
      options:
        "--batch-mode --quiet -P build-web-console
      -Dout=$(Build.SourcesDirectory)/ci/qlog.conf -Dhttp.keepAlive=false"
      jdkVersionOption: $(jdk)
    timeoutInMinutes: 55
    condition: |
      and(
        eq(variables['testset'], 'none'),
        eq(variables['SOURCE_CODE_CHANGED'], 'true')
      )
  - task: Maven@3
    displayName: "Run tests with Maven with Code Coverage (griffin)"
    inputs:
      mavenPomFile: "core/pom.xml"
      mavenOptions: "$(MAVEN_OPTS)"
      goals: "test"
      options:
        "--batch-mode --quiet -P build-web-console -Dtest=griffin.**
        -Dout=$(Build.SourcesDirectory)/ci/qlog.conf -Dhttp.keepAlive=false"
      jdkVersionOption: $(jdk)
      codeCoverageToolOption: "$(CODE_COVERAGE_TOOL_OPTION)"
      codeCoverageClassFilter: "$(COVERAGE_DIFF)"
    timeoutInMinutes: 55
    condition: |
      and(
        eq(variables['testset'], 'coverage-griffin'),
        eq(variables['SOURCE_CODE_CHANGED'], 'true')
      )
  - task: Maven@3
    displayName: "Run tests with Maven with Code Coverage (non-griffin)"
    inputs:
      mavenPomFile: "core/pom.xml"
      mavenOptions: "$(MAVEN_OPTS)"
      goals: "test"
      options:
        "--batch-mode --quiet -P build-web-console -Dtest.exclude=**/griffin/**
      -Dout=$(Build.SourcesDirectory)/ci/qlog.conf -Dhttp.keepAlive=false"
      jdkVersionOption: $(jdk)
      codeCoverageToolOption: "$(CODE_COVERAGE_TOOL_OPTION)"
      codeCoverageClassFilter: "$(COVERAGE_DIFF)"
    timeoutInMinutes: 55
    condition: |
      and(
        eq(variables['testset'], 'coverage-non-griffin'),
        eq(variables['SOURCE_CODE_CHANGED'], 'true')
      )
  - task: Maven@3
    displayName: "Run tests with Maven (non griffin)"
    inputs:
      mavenPomFile: "pom.xml"
      mavenOptions: "$(MAVEN_OPTS)"
      goals: "clean test"
      options:
        "--batch-mode --quiet -P build-web-console
        -Dout=$(Build.SourcesDirectory)/ci/qlog.conf -Dhttp.keepAlive=false -Dtest.exclude=**/griffin/** -DfailIfNoTests=false"
      jdkVersionOption: $(jdk)
    timeoutInMinutes: 55
    condition: |
      and(
        eq(variables['testset'], 'non-griffin'),
        eq(variables['SOURCE_CODE_CHANGED'], 'true')
      )
  - task: Maven@3
    displayName: "Run tests with Maven (griffin)"
    inputs:
      mavenPomFile: "pom.xml"
      mavenOptions: "$(MAVEN_OPTS)"
      goals: "clean test"
      options:
        "--batch-mode --quiet -P build-web-console
        -Dout=$(Build.SourcesDirectory)/ci/qlog.conf -Dhttp.keepAlive=false -Dtest=griffin.** -DfailIfNoTests=false"
      jdkVersionOption: $(jdk)
    timeoutInMinutes: 55
    condition: |
      and(
        eq(variables['testset'], 'griffin'),
        eq(variables['SOURCE_CODE_CHANGED'], 'true')
      )
  - task: ArchiveFiles@2
    displayName: "Tests failed -- Compress logs"
    condition: not(succeeded())
    inputs:
      rootFolderOrFile: $(QDB_LOG_W_FILE_LOCATION)
      includeRootFolder: false
      archiveFile: $(ARCHIVED_LOGS)
      quiet: true
  - task: PublishBuildArtifacts@1
    displayName: "Tests failed -- Upload logs"
    condition: not(succeeded())
    inputs:
      pathToPublish: $(ARCHIVED_LOGS)
      artifactName: MavenFailedTestsLogs
  - publish: '$(Build.SourcesDirectory)/core/CCReport43F6D5EF/jacoco.xml'
    displayName: 'Publish jacoco report'
    artifact: $(testset)
    condition: |
      and(
        or(eq(variables['testset'], 'coverage-griffin'),eq(variables['testset'], 'coverage-non-griffin')),
        eq(variables['SOURCE_CODE_CHANGED'], 'true')
      )