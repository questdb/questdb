steps:
  - bash: |
      wget "https://download.jetbrains.com/product?code=IIC&latest&distribution=linux" -O intellij.tar.gz
      mkdir -p /opt/intellij
      tar xvz -C /opt/intellij -f intellij.tar.gz
      rm intellij.tar.gz
      cd /opt/intellij
      ln -s idea-* idea
      echo "JAVA_HOME: $JAVA_HOME"
      echo "java --version"
      java --version
    displayName: "Install IntelliJ"
  - bash: /opt/intellij/idea/bin/idea.sh format -s .idea/codeStyles/Project.xml -m "*.java" -r .
    displayName: "Applying formatting"
  - bash: git status -s
    displayName: "List of affected files"
  - bash: git diff --exit-code
    displayName: "List of required changes"
  - bash: |
      mkdir -p $(Agent.TempDirectory)/qodana-results

      # Run full scan if lint config changed, otherwise incremental scan
      if [ "$(LINT_CONFIG_CHANGED)" = "true" ]; then
        echo "Lint config changed - running full inspection"
        DIFF_ARG=""
      else
        echo "Running incremental inspection on changed files only"
        git fetch origin $(System.PullRequest.TargetBranch) --depth=1 || true
        DIFF_ARG="--diff-start=origin/$(System.PullRequest.TargetBranch)"
      fi

      docker run --rm \
        -v "$(pwd):/data/project" \
        -v "$(Agent.TempDirectory)/qodana-results:/data/results" \
        jetbrains/qodana-jvm-community:latest \
        $DIFF_ARG \
        --print-problems 2>&1 | tee $(Agent.TempDirectory)/qodana-results/qodana-output.txt
    displayName: "Run Qodana inspections"
    timeoutInMinutes: 55
  - bash: |
      RESULTS_DIR="$(Agent.TempDirectory)/qodana-results"
      SARIF_FILE="$RESULTS_DIR/qodana.sarif.json"

      if [ ! -f "$SARIF_FILE" ]; then
        echo "##vso[task.logissue type=error]SARIF results file not found"
        exit 1
      fi

      echo "=== Qodana Inspection Results ==="
      echo ""

      # Parse SARIF JSON and output problems with descriptions
      jq -r '.runs[0].results[] | "\(.level | ascii_upcase) \(.ruleId)\n  File: \(.locations[0].physicalLocation.artifactLocation.uri):\(.locations[0].physicalLocation.region.startLine)\n  \(.message.text)\n"' "$SARIF_FILE" | head -500

      PROBLEM_COUNT=$(jq '.runs[0].results | length' "$SARIF_FILE")

      echo "=== Summary ==="
      echo "Total problems found: $PROBLEM_COUNT"

      # Fail the build if any problems are found
      if [ "$PROBLEM_COUNT" -gt 0 ]; then
        echo "##vso[task.logissue type=error]Qodana found $PROBLEM_COUNT code inspection problems"
        exit 1
      fi
    displayName: "Check inspection results"

