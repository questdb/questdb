steps:
  - bash: |
      wget "https://download.jetbrains.com/product?code=IIC&latest&distribution=linux" -O intellij.tar.gz
      mkdir -p /opt/intellij
      tar xvz -C /opt/intellij -f intellij.tar.gz
      rm intellij.tar.gz
      cd /opt/intellij
      ln -s idea-* idea
      echo "JAVA_HOME: $JAVA_HOME"
      echo "java --version"
      java --version
    displayName: "Install IntelliJ"
  - bash: /opt/intellij/idea/bin/idea.sh format -s .idea/codeStyles/Project.xml -m "*.java" -r .
    displayName: "Applying formatting"
  - bash: git status -s
    displayName: "List of affected files"
  - bash: git diff --exit-code
    displayName: "List of required changes"
  - bash: |
      mkdir -p $(Agent.TempDirectory)/inspection-results
      /opt/intellij/idea/bin/idea.sh inspect . .idea/inspectionProfiles/Project_Default.xml $(Agent.TempDirectory)/inspection-results -v2 -d core/src/main/java
    displayName: "Run IntelliJ inspections"
  - bash: |
      # Check inspection results for errors
      if find $(Agent.TempDirectory)/inspection-results -name "*.xml" -type f | head -1 | xargs -r grep -l "<problem" > /dev/null 2>&1; then
        echo "Inspection found problems:"
        cat $(Agent.TempDirectory)/inspection-results/*.xml
        exit 1
      else
        echo "No inspection problems found"
      fi
    displayName: "Check inspection results"

