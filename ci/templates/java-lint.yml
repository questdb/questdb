steps:
  - bash: |
      wget "https://download.jetbrains.com/product?code=IIC&latest&distribution=linux" -O intellij.tar.gz
      mkdir -p /opt/intellij
      tar xvz -C /opt/intellij -f intellij.tar.gz
      rm intellij.tar.gz
      cd /opt/intellij
      ln -s idea-* idea
      echo "JAVA_HOME: $JAVA_HOME"
      echo "java --version"
      java --version
    displayName: "Install IntelliJ"
  - bash: /opt/intellij/idea/bin/idea.sh format -s .idea/codeStyles/Project.xml -m "*.java" -r .
    displayName: "Applying formatting"
  - bash: git status -s
    displayName: "List of affected files"
  - bash: git diff --exit-code
    displayName: "List of required changes"
  - bash: |
      mkdir -p $(Agent.TempDirectory)/inspection-results
      /opt/intellij/idea/bin/idea.sh inspect . .idea/inspectionProfiles/Project_Default.xml $(Agent.TempDirectory)/inspection-results -v2
    displayName: "Run IntelliJ inspections"
  - bash: |
      echo "Inspection results directory contents:"
      ls -la $(Agent.TempDirectory)/inspection-results/ || true
      echo "---"
      # Check inspection results for problems
      if find $(Agent.TempDirectory)/inspection-results -name "*.xml" -type f 2>/dev/null | xargs -r grep -l "<problem" > /dev/null 2>&1; then
        echo "Inspection found problems:"
        for f in $(Agent.TempDirectory)/inspection-results/*.xml; do
          if grep -q "<problem" "$f" 2>/dev/null; then
            echo "=== $f ==="
            cat "$f"
          fi
        done
        exit 1
      else
        echo "No inspection problems found"
      fi
    displayName: "Check inspection results"

