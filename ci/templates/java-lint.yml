steps:
  - bash: |
      wget "https://download.jetbrains.com/product?code=IIC&latest&distribution=linux" -O intellij.tar.gz
      mkdir -p /opt/intellij
      tar xvz -C /opt/intellij -f intellij.tar.gz
      rm intellij.tar.gz
      cd /opt/intellij
      ln -s idea-* idea
      echo "JAVA_HOME: $JAVA_HOME"
      echo "java --version"
      java --version
    displayName: "Install IntelliJ"
  - bash: /opt/intellij/idea/bin/idea.sh format -s .idea/codeStyles/Project.xml -m "*.java" -r .
    displayName: "Applying formatting"
  - bash: git status -s
    displayName: "List of affected files"
  - bash: git diff --exit-code
    displayName: "List of required changes"
  - bash: |
      mkdir -p $(Agent.TempDirectory)/inspection-results
      /opt/intellij/idea/bin/idea.sh inspect . .idea/inspectionProfiles/Project_Default.xml $(Agent.TempDirectory)/inspection-results -v2
    displayName: "Run IntelliJ inspections"
  - bash: |
      RESULTS_DIR="$(Agent.TempDirectory)/inspection-results"
      HTML_REPORT="$RESULTS_DIR/inspection-report.html"
      PROBLEM_COUNT=0

      # Start HTML report
      cat > "$HTML_REPORT" << 'HTMLHEAD'
      <!DOCTYPE html>
      <html>
      <head>
        <title>IntelliJ Inspection Results</title>
        <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; }
          h1 { color: #333; }
          table { border-collapse: collapse; width: 100%; margin-top: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #4a90d9; color: white; }
          tr:nth-child(even) { background-color: #f9f9f9; }
          tr:hover { background-color: #f1f1f1; }
          .severity-ERROR { color: #d32f2f; font-weight: bold; }
          .severity-WARNING { color: #f57c00; }
          .severity-WEAK { color: #7b1fa2; }
          .severity-INFO { color: #1976d2; }
          .file { font-family: monospace; font-size: 0.9em; }
          .summary { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
        </style>
      </head>
      <body>
      <h1>IntelliJ Inspection Results</h1>
      <div class="summary" id="summary"></div>
      <table>
      <tr><th>Severity</th><th>File</th><th>Line</th><th>Problem</th><th>Description</th></tr>
      HTMLHEAD

      echo "=== Inspection Results ==="

      # Process each XML file
      for f in "$RESULTS_DIR"/*.xml; do
        [ -f "$f" ] || continue
        INSPECTION_NAME=$(basename "$f" .xml)

        # Parse problems using xmllint or grep/sed fallback
        while IFS= read -r problem_block; do
          file=$(echo "$problem_block" | grep -oP '(?<=<file>)[^<]+' | sed 's|file://\$USER_HOME\$|~|g' | sed 's|.*/work/1/s/||')
          line=$(echo "$problem_block" | grep -oP '(?<=<line>)[^<]+')
          severity=$(echo "$problem_block" | grep -oP 'severity="[^"]+"' | cut -d'"' -f2)
          problem_class=$(echo "$problem_block" | grep -oP '(?<=<problem_class[^>]*>)[^<]+')
          description=$(echo "$problem_block" | grep -oP '(?<=<description>)[^<]+')

          if [ -n "$file" ]; then
            PROBLEM_COUNT=$((PROBLEM_COUNT + 1))
            # Console output: one line per problem
            printf "%-8s %-60s %-5s %s: %s\n" "[$severity]" "$file" ":$line" "$problem_class" "$description"
            # HTML output
            echo "<tr><td class=\"severity-$severity\">$severity</td><td class=\"file\">$file</td><td>$line</td><td>$problem_class</td><td>$description</td></tr>" >> "$HTML_REPORT"
          fi
        done < <(grep -oP '<problem>.*?</problem>' "$f" | sed 's/<problem>/\n<problem>/g')
      done

      # Finish HTML report
      cat >> "$HTML_REPORT" << HTMLFOOT
      </table>
      <script>document.getElementById('summary').innerHTML = 'Total problems found: <strong>$PROBLEM_COUNT</strong>';</script>
      </body>
      </html>
      HTMLFOOT

      echo "=== Summary ==="
      echo "Total problems found: $PROBLEM_COUNT"
      echo "HTML report: $HTML_REPORT"

      if [ "$PROBLEM_COUNT" -gt 0 ]; then
        exit 1
      fi
    displayName: "Check inspection results"
  - task: PublishPipelineArtifact@1
    condition: always()
    inputs:
      targetPath: '$(Agent.TempDirectory)/inspection-results'
      artifact: 'inspection-report'
      publishLocation: 'pipeline'
    displayName: "Publish inspection report"

