
statement ok
CREATE TABLE sales(empid INT, amount INT, d DATE);

statement ok
INSERT INTO sales VALUES
    (1, 10000, DATE '2000-01-01'),
    (1, 400, DATE '2000-01-07'),
    (2, 4500, DATE '2001-01-21'),
    (2, 35000, DATE '2001-01-21'),
    (1, 5000, DATE '2000-02-03'),
    (1, 3000, DATE '2000-02-07'),
    (2, 200, DATE '2001-02-05'),
    (2, 90500, DATE '2001-02-19'),
    (1, 6000, DATE '2000-03-01'),
    (1, 5000, DATE '2000-03-09'),
    (2, 2500, DATE '2001-03-03'),
    (2, 9500, DATE '2001-03-08');



# PIVOT over a subquery
#PIVOT (SELECT YEAR(d) AS year, MONTH(d) AS month, empid, amount FROM sales) ON YEAR, MONTH USING SUM(AMOUNT) ORDER BY ALL;
query IIIIIII
WITH a AS (
  SELECT YEAR(d) as year, MONTH(d) as month, empid, amount FROM sales ORDER BY year, month
), b AS (
  SELECT empid, amount, concat(year, '_', month) as name FROM a
)
SELECT * FROM b PIVOT (SUM(amount) FOR name IN (SELECT DISTINCT name FROM b ORDER BY name)) GROUP BY empid;
----
1	10400	8000	11000	NULL	NULL	NULL
2	NULL	NULL	NULL	39500	90700	12000


#PIVOT (PIVOT (SELECT YEAR(d) AS year, MONTH(d) AS month, empid, amount FROM sales) ON YEAR, MONTH USING SUM(AMOUNT))
#ON empid USING SUM(COALESCE("2000_1",0) + COALESCE("2000_2",0) + COALESCE("2000_3",0) + COALESCE("2001_1",0) + COALESCE("2001_2",0) + COALESCE("2001_3",0))
query II
WITH a AS (
  SELECT YEAR(d) as year, MONTH(d) as month, empid, amount FROM sales ORDER BY year, month
), b AS (
  SELECT empid, amount, concat(year, '_', month) as name FROM a
), first_pivot AS (
  SELECT * FROM b PIVOT (SUM(amount) FOR name IN (SELECT DISTINCT name FROM b ORDER BY name)) GROUP BY empid
)
SELECT * FROM first_pivot PIVOT (SUM(
  COALESCE("2000_1",0)
  + COALESCE("2000_2",0)
  + COALESCE("2000_3",0)
  + COALESCE("2001_1",0)
  + COALESCE("2001_2",0)
  + COALESCE("2001_3",0)
) FOR empid IN (SELECT DISTINCT empid FROM first_pivot ORDER BY empid));
----
29400	142200


#statement error
#CREATE VIEW pivot_view AS PIVOT (SELECT YEAR(d) AS year, MONTH(d) AS month, empid, amount FROM sales) ON YEAR, MONTH USING SUM(AMOUNT);
#----
#cannot be used in views
#
#statement error
#CREATE MACRO xt2(a) as TABLE PIVOT sales ON d USING SUM(amount)
#----
#cannot be used in macros
#
#statement error
#CREATE MACRO xt2(a) as (PIVOT sales ON d USING SUM(amount))
#----
#cannot be used in macros