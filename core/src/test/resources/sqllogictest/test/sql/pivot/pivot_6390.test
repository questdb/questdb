statement ok

CREATE TABLE cpb_tbl AS (
  SELECT C1 AS CPDH, "2022" AS NF, "10" AS JG FROM (
    SELECT 'C1',2022,10
    UNION ALL
    SELECT 'C1',2018,20
    UNION ALL
    SELECT 'C1',2017,0
    UNION ALL
    SELECT 'C2',2022,10
    UNION ALL
    SELECT 'C2',2010,30
    UNION ALL
    SELECT 'C3',2010,80
  )
);

# pivot cpb_tbl on nf using sum(jg)group by cpdh
query IIIII rowsort pivot
cpb_tbl PIVOT (sum(JG) FOR NF IN (2022, 2018, 2017, 2010) GROUP BY CPDH ORDER BY CPDH);
----
C1 10 20 0 NULL
C2 10 NULL NULL 30
C3 NULL NULL NULL 80

# WITH CPB(CPDH,NF,JG) AS (
# SELECT 'C1',2022,10
# UNION ALL
# SELECT 'C1',2018,20
# UNION ALL
# SELECT 'C1',2017,0
# UNION ALL
# SELECT 'C2',2022,10
# UNION ALL
# SELECT 'C2',2010,30
# UNION ALL
# SELECT 'C3',2010,80
# )
# pivot CPB on nf IN (2010, 2017, 2018, 2022) using sum(jg)group by cpdh
query IIIII rowsort pivot
WITH CPB AS (
   SELECT C1 AS CPDH, "2022" AS NF, "10" AS JG FROM (
    SELECT 'C1',2022,10
    UNION ALL
    SELECT 'C1',2018,20
    UNION ALL
    SELECT 'C1',2017,0
    UNION ALL
    SELECT 'C2',2022,10
    UNION ALL
    SELECT 'C2',2010,30
    UNION ALL
    SELECT 'C3',2010,80
  )
)
SELECT * FROM CPB PIVOT (sum(JG) FOR NF IN (2010, 2017, 2018, 2022) GROUP BY CPDH ORDER BY CPDH);
----
C1 NULL 0 20 10
C2 30 NULL NULL 10
C3 80 NULL NULL NULL


# cannot use with inside the subquery
query IIIII rowsort pivot
WITH CPB AS (
SELECT 'C1' AS CPDH, 2022 AS NF, 10 AS JG
UNION ALL
SELECT 'C1',2018,20
UNION ALL
SELECT 'C1',2017,0
UNION ALL
SELECT 'C2',2022,10
UNION ALL
SELECT 'C2',2010,30
UNION ALL
SELECT 'C3',2010,80
)
SELECT * FROM CPB PIVOT (sum(jg) FOR nf IN (SELECT DISTINCT NF FROM CPB) GROUP BY CPDH ORDER BY CPDH);
----
C1 0 10 NULL 20
C2 NULL 10 30 NULL
C3 NULL NULL 80 NULL

#query IIIII rowsort pivot
#WITH CPB(CPDH,NF,JG) AS (
#SELECT 'C1',2022,10
#UNION ALL
#SELECT 'C1',2018,20
#UNION ALL
#SELECT 'C1',2017,0
#UNION ALL
#SELECT 'C2',2022,10
#UNION ALL
#SELECT 'C2',2010,30
#UNION ALL
#SELECT 'C3',2010,80
#)
#SELECT *
#FROM  (pivot CPB on nf using sum(jg)group by cpdh)
#----

#query IIIII rowsort pivot
#WITH CPB(CPDH,NF,JG) AS (
#SELECT 'C1',2022,10
#UNION ALL
#SELECT 'C1',2018,20
#UNION ALL
#SELECT 'C1',2017,0
#UNION ALL
#SELECT 'C2',2022,10
#UNION ALL
#SELECT 'C2',2010,30
#UNION ALL
#SELECT 'C3',2010,80
#)
#from CPB pivot (sum(jg) for nf in (2010, 2017, 2018, 2022) group by cpdh)
#----

# nested CTEs with overlapping names
#query IIIII rowsort pivot
#WITH CPB AS (SELECT 42)
#SELECT *
#FROM  (
#	WITH CPB(CPDH,NF,JG) AS (
#		SELECT 'C1',2022,10
#		UNION ALL
#		SELECT 'C1',2018,20
#		UNION ALL
#		SELECT 'C1',2017,0
#		UNION ALL
#		SELECT 'C2',2022,10
#		UNION ALL
#		SELECT 'C2',2010,30
#		UNION ALL
#		SELECT 'C3',2010,80
#	)
#	pivot CPB on nf using sum(jg) group by cpdh)
#----


statement error
WITH CPB AS (SELECT 42)
SELECT * FROM
 (
  WITH CPB AS (
   SELECT C1 AS CPDH, "2022" AS NF, "10" AS JG FROM (
    SELECT 'C1',2022,10
    UNION ALL
    SELECT 'C1',2018,20
    UNION ALL
    SELECT 'C1',2017,0
    UNION ALL
    SELECT 'C2',2022,10
    UNION ALL
    SELECT 'C2',2010,30
    UNION ALL
    SELECT 'C3',2010,80
  )
  SELECT * FROM CPB PIVOT (sum(JG) FOR NF IN (2010, 2017, 2018, 2022) GROUP BY CPDH ORDER BY CPDH);
);
----

#query IIIII rowsort pivot
#WITH CPB(CPDH,NF,JG) AS MATERIALIZED (
#SELECT 'C1',2022,10
#UNION ALL
#SELECT 'C1',2018,20
#UNION ALL
#SELECT 'C1',2017,0
#UNION ALL
#SELECT 'C2',2022,10
#UNION ALL
#SELECT 'C2',2010,30
#UNION ALL
#SELECT 'C3',2010,80
#)
#pivot CPB on nf IN (2010, 2017, 2018, 2022) using sum(jg)group by cpdh
#----
#
#query IIIII rowsort pivot
#WITH CPB(CPDH,NF,JG) AS MATERIALIZED (
#SELECT 'C1',2022,10
#UNION ALL
#SELECT 'C1',2018,20
#UNION ALL
#SELECT 'C1',2017,0
#UNION ALL
#SELECT 'C2',2022,10
#UNION ALL
#SELECT 'C2',2010,30
#UNION ALL
#SELECT 'C3',2010,80
#)
#pivot CPB on nf using sum(jg)group by cpdh
#----
#
#query IIIII rowsort pivot
#WITH CPB(CPDH,NF,JG) AS MATERIALIZED (
#SELECT 'C1',2022,10
#UNION ALL
#SELECT 'C1',2018,20
#UNION ALL
#SELECT 'C1',2017,0
#UNION ALL
#SELECT 'C2',2022,10
#UNION ALL
#SELECT 'C2',2010,30
#UNION ALL
#SELECT 'C3',2010,80
#)
#SELECT *
#FROM  (pivot CPB on nf using sum(jg)group by cpdh)
#----
#
#query IIIII rowsort pivot
#WITH CPB(CPDH,NF,JG) AS MATERIALIZED (
#SELECT 'C1',2022,10
#UNION ALL
#SELECT 'C1',2018,20
#UNION ALL
#SELECT 'C1',2017,0
#UNION ALL
#SELECT 'C2',2022,10
#UNION ALL
#SELECT 'C2',2010,30
#UNION ALL
#SELECT 'C3',2010,80
#)
#from CPB pivot (sum(jg) for nf in (2010, 2017, 2018, 2022) group by cpdh)
#----
#
## nested CTEs with overlapping names
#query IIIII rowsort pivot
#WITH CPB AS (SELECT 42)
#SELECT *
#FROM  (
#	WITH CPB(CPDH,NF,JG) AS MATERIALIZED (
#		SELECT 'C1',2022,10
#		UNION ALL
#		SELECT 'C1',2018,20
#		UNION ALL
#		SELECT 'C1',2017,0
#		UNION ALL
#		SELECT 'C2',2022,10
#		UNION ALL
#		SELECT 'C2',2010,30
#		UNION ALL
#		SELECT 'C3',2010,80
#	)
#	pivot CPB on nf using sum(jg) group by cpdh)
#----