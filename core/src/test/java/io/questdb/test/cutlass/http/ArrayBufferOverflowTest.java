/*******************************************************************************
 *     ___                  _   ____  ____
 *    / _ \ _   _  ___  ___| |_|  _ \| __ )
 *   | | | | | | |/ _ \/ __| __| | | |  _ \
 *   | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *    \__\_\\__,_|\___||___/\__|____/|____/
 *
 *  Copyright (c) 2014-2019 Appsicle
 *  Copyright (c) 2019-2024 QuestDB
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 ******************************************************************************/

package io.questdb.test.cutlass.http;

import io.questdb.cairo.CairoConfiguration;
import io.questdb.cairo.DefaultCairoConfiguration;
import io.questdb.cairo.arr.ArrayTypeDriver;
import io.questdb.cairo.arr.ArrayWriteState;
import io.questdb.cairo.arr.DirectArray;
import io.questdb.cairo.arr.NoopArrayWriteState;
import io.questdb.std.NanosecondClock;
import io.questdb.std.datetime.microtime.MicrosecondClock;
import io.questdb.std.str.CharSink;
import io.questdb.std.str.StringSink;
import io.questdb.std.str.Utf16Sink;
import io.questdb.test.AbstractTest;
import io.questdb.test.tools.TestUtils;
import org.jetbrains.annotations.NotNull;
import org.junit.BeforeClass;
import org.junit.Ignore;
import org.junit.Test;

public class ArrayBufferOverflowTest extends AbstractTest {
    private static CairoConfiguration configuration;

    @BeforeClass
    public static void setUpStatic() throws Exception {
        AbstractTest.setUpStatic();
        configuration = new DefaultCairoConfiguration(root) {
            @Override
            public @NotNull MicrosecondClock getMicrosecondClock() {
                // this fixes the random seeds used by rnd_array()
                return () -> 1234;
            }

            @Override
            public @NotNull NanosecondClock getNanosecondClock() {
                return () -> 5678;
            }
        };
    }

    @Test
    public void testArrayToTextContinuity() {
        try (DirectArray arrayView = new DirectArray(configuration)) {
            var rnd = TestUtils.generateRandom(LOG);
            rnd.nextDoubleArray(Math.max(1, rnd.nextInt(4)), arrayView, 1, 10, 0);
            var sinkActual = new StringSink();
            var sinkExpected = new StringSink();
            // we do not split values yet, such as double, so the sink should be
            // large enough for at least 1 value.
            var chunkSize = Math.max(31, rnd.nextInt(10000));
            var sinkInterrupted = new Utf16Sink() {
                private boolean bufOut = true;

                @Override
                public Utf16Sink put(char c) {
                    if (sinkActual.length() > 0 && (sinkActual.length() % chunkSize) == 0) {
                        if (bufOut) {
                            // interrupt the sinking on each chunk
                            // when we reach the chunk, we expect the code to retry to climb over
                            // this chunk, and continue, but we will fail again on the next chunk
                            bufOut = false;
                            throw new RuntimeException("buf out");
                        } else {
                            bufOut = true;
                        }
                    }
                    return sinkActual.put(c);
                }
            };

            var statePrototype = new ArrayWriteState() {
                int opsAlreadyDone;
                int opsSeenSinceRestart;
                int sinkLen = 0;

                @Override
                public boolean incAndSayIfNewOp() {
                    opsSeenSinceRestart++;
                    return opsSeenSinceRestart > opsAlreadyDone;
                }

                @Override
                public void performedOp() {
                    opsAlreadyDone = Math.max(opsAlreadyDone, opsSeenSinceRestart);
                    sinkLen = sinkActual.length();
                }

                @Override
                public void putCharIfNew(CharSink<?> sink, char symbol) {
                    if (incAndSayIfNewOp()) {
                        sink.put(symbol);
                    }
                    performedOp();
                }
            };

            while (true) {
                try {
                    ArrayTypeDriver.arrayToJson(
                            arrayView,
                            sinkInterrupted,
                            ArrayTypeDriver::appendDoubleFromArrayToSinkJson,
                            statePrototype
                    );
                    break;
                } catch (Throwable e) {
                    sinkActual.trimTo(statePrototype.sinkLen);
                    statePrototype.opsSeenSinceRestart = 0;
                }
            }

            ArrayTypeDriver.arrayToJson(
                    arrayView,
                    sinkExpected,
                    ArrayTypeDriver::appendDoubleFromArrayToSinkJson,
                    NoopArrayWriteState.INSTANCE
            );

            TestUtils.assertEquals(sinkExpected, sinkActual);
        }
    }

    @Test
    public void testJsonHttp() throws Exception {
        var rnd = TestUtils.generateRandom(LOG);
        TestUtils.assertMemoryLeak(() -> {
            HttpServerConfigurationBuilder httpServerConfigurationBuilder = new HttpServerConfigurationBuilder();
            httpServerConfigurationBuilder.withSendBufferSize(Math.max(384, rnd.nextInt(2048)));
            new HttpQueryTestBuilder()
                    .withTempFolder(root)
                    .withWorkerCount(1)
                    .withHttpServerConfigBuilder(httpServerConfigurationBuilder)
                    .withTelemetry(false).run(configuration, (engine, sqlExecutionContext) -> {
                        try (TestHttpClient testHttpClient = new TestHttpClient()) {
                            testHttpClient.assertGet(
                                    "{\"query\":\"select x i, rnd_double_array(3, 1, 0, 6, 5, 5) a from long_sequence(10);\",\"columns\":[{\"name\":\"i\",\"type\":\"LONG\"},{\"name\":\"a\",\"type\":\"ARRAY\",\"dim\":3,\"elemType\":\"DOUBLE\"}],\"timestamp\":-1,\"dataset\":[[1,[[[3.140643285813871E-4,0.69326537621448,\"NaN\",0.28611020049545155,\"NaN\"],[\"NaN\",\"NaN\",0.5395556701065334,0.1414022742755634,\"NaN\"],[0.4752350123164646,0.6012657989910146,\"NaN\",0.585843770955637,\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",0.40606013316388134,\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"]],[[\"NaN\",\"NaN\",\"NaN\",0.5991208536973013,\"NaN\"],[0.9871985652253371,\"NaN\",0.18913032301894672,\"NaN\",0.3000363025683642],[0.43616277818500915,0.08657222778592621,0.14893292888311582,0.21270770921920534,0.5608015822958148],[\"NaN\",0.6319160111413077,\"NaN\",\"NaN\",0.5811707053522398],[0.6201771582888651,0.8063107890584933,\"NaN\",\"NaN\",0.15558156333753415]],[[0.9360481563399781,0.4427989924185698,\"NaN\",\"NaN\",\"NaN\"],[0.6338323241897774,0.8363524710257856,\"NaN\",0.2801838877829529,0.011505636475178882],[0.11516578622333529,\"NaN\",0.5455556321733311,0.9001351934403463,0.1077875767567732],[\"NaN\",0.9267643777579697,0.9721119491190986,\"NaN\",0.35964115008734654],[0.42562822640930975,\"NaN\",0.2529188867293015,\"NaN\",0.5309250101098157]],[[\"NaN\",0.784319824158902,0.9332198681153373,0.23900556474173051,\"NaN\"],[0.9847596838028854,0.5936397607121807,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",0.30458754305760216,\"NaN\",0.7382439636961146],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[0.028023202541271552,\"NaN\",\"NaN\",\"NaN\",\"NaN\"]],[[0.2550987399566025,0.26998063364754565,0.48553627411000255,\"NaN\",\"NaN\"],[0.9149475104319955,0.34010418384031016,0.33067919657781575,0.2991619325507572,\"NaN\"],[\"NaN\",0.14508948012827227,0.5471104536442293,\"NaN\",\"NaN\"],[0.39133262243846456,0.14939745795088222,\"NaN\",0.2834693915481332,0.4667925424641276],[\"NaN\",0.6100098794868637,\"NaN\",0.9978847217852047,0.9087973139283032]],[[\"NaN\",0.6729332686036003,0.3136394834603561,0.32051007905454854,0.24847919277865826],[\"NaN\",\"NaN\",0.4170561750437699,\"NaN\",0.5077538022340554],[\"NaN\",\"NaN\",0.33054550160950924,0.9852757658028125,0.42075355831328076],[0.5589479147681313,0.01698255462610221,0.004173800793017768,\"NaN\",0.21500439422034878],[0.3343834474562737,0.5802903532666576,0.36021288429451503,0.5232435236521195,0.6241404240587153]]]],[2,[[[\"NaN\",0.3625739584222255,\"NaN\",\"NaN\",0.8715957334272174],[\"NaN\",0.6981204218210215,\"NaN\",\"NaN\",0.4789079242814711],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.4657235232836129],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.4925290165795897],[0.2845729124745331,\"NaN\",\"NaN\",0.5600938003214948,\"NaN\"]],[[\"NaN\",0.5110349447094176,0.7609549086216094,0.712426440067183,\"NaN\"],[0.5196476350387685,0.809222446377486,0.19085246561089975,\"NaN\",\"NaN\"],[0.1258282732241729,\"NaN\",0.11325766135215543,\"NaN\",\"NaN\"],[0.6328443358620268,\"NaN\",0.6814372353820676,0.30291527029628107,0.06160478275027348],[0.49990090684101296,\"NaN\",\"NaN\",0.13230031112011953,0.5899978129923895]],[[\"NaN\",0.663127231109937,0.7918446314679398,\"NaN\",\"NaN\"],[0.5106730538390831,0.5020685834316602,0.4088852574680012,0.5857925358362319,0.9969836895471604],[\"NaN\",\"NaN\",\"NaN\",0.22374362908836276,0.6327157066881115],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.9334413940165974],[0.5080514829400804,0.4592718298298374,\"NaN\",\"NaN\",\"NaN\"]],[[0.45390337504345846,0.5080689995125803,0.49344546021927094,0.10397147831405107,\"NaN\"],[0.14898060387981882,\"NaN\",\"NaN\",0.4844601167172399,\"NaN\"],[0.824076010336407,\"NaN\",\"NaN\",0.39176662665084594,\"NaN\"],[\"NaN\",0.1840786233366638,\"NaN\",0.0222576440125547,0.14094076327022687],[0.6181874980917226,0.7082847456484765,\"NaN\",\"NaN\",\"NaN\"]],[[0.6161402197064566,\"NaN\",0.3478570816173613,0.8258372156546406,\"NaN\"],[0.9675876829379909,0.7020491711331152,\"NaN\",0.9276633302839218,\"NaN\"],[\"NaN\",0.9019633479004099,0.036511800576904396,0.4137763602532154,0.4530084570382452],[0.01733741552691881,\"NaN\",\"NaN\",0.08128765779919345,\"NaN\"],[0.22450260293050006,\"NaN\",\"NaN\",0.947648217247076,0.5150255333301709]],[[0.09862030224478213,0.5792866960913927,\"NaN\",0.9020516321848266,0.9418375788143808],[0.013581540669556524,\"NaN\",\"NaN\",0.5521983891704567,0.3345830183347629],[0.11278012801599668,\"NaN\",0.41526333342641597,0.46715795851277564,0.08205243298844189],[0.9143831813584994,0.5869710656363932,\"NaN\",\"NaN\",\"NaN\"],[0.14141030145763844,0.4616806226805663,\"NaN\",\"NaN\",\"NaN\"]]]],[3,[[[\"NaN\",0.7441762142201299,\"NaN\",0.9007685633526413,\"NaN\"],[\"NaN\",0.09870621758114917,\"NaN\",\"NaN\",0.5212800926402809],[\"NaN\",\"NaN\",0.2665147189066862,\"NaN\",0.6596016325018639],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.3289865899620855],[\"NaN\",\"NaN\",\"NaN\",0.6947608978601755,\"NaN\"]],[[0.35295079323045075,0.17827118615542348,\"NaN\",0.7353499602569634,0.9937226635851747],[0.6467408377797746,\"NaN\",\"NaN\",0.015471125917476458,\"NaN\"],[0.6873870516177227,\"NaN\",0.8108831679925128,0.5672618974103468,0.18142244552049425],[0.9653350589425297,0.6907773125478485,0.49704803890433114,0.9988072081672303,\"NaN\"],[\"NaN\",0.7548788608971204,0.7025981871298874,0.1873572115879738,0.3876649534979676]],[[0.8889347281597823,\"NaN\",0.3677284485126112,\"NaN\",\"NaN\"],[0.2713629319580093,\"NaN\",0.22487682684834898,0.9247914156115961,\"NaN\"],[\"NaN\",0.13047900616491237,\"NaN\",0.7907367407608518,\"NaN\"],[0.35415409494351,0.03126813961360764,0.2446165709405037,\"NaN\",\"NaN\"],[0.30864730519143946,\"NaN\",0.9802235708350467,0.4967594942625583,0.16811223457711422]],[[\"NaN\",\"NaN\",0.816199041941703,0.22124517201539007,\"NaN\"],[\"NaN\",\"NaN\",0.9341747148492238,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",0.8020514273264906,\"NaN\",0.8804206933491007],[\"NaN\",0.0012498640366348512,0.07498503244627697,0.5375592327504564,\"NaN\"],[\"NaN\",0.6194294357020026,\"NaN\",\"NaN\",0.6646355825030826]],[[0.4792215863147231,0.9895478229929195,\"NaN\",\"NaN\",0.43263940239144116],[0.6797218754063832,\"NaN\",0.10190699880145715,0.6281158131097979,\"NaN\"],[0.22557349725908127,0.5687027619533433,0.893977719461526,0.31828902314670326,0.2791260274882422],[\"NaN\",0.9444113594020382,0.21710217143333221,0.10850424938817349,\"NaN\"],[0.36363266360706703,\"NaN\",0.5768695267498187,\"NaN\",\"NaN\"]],[[\"NaN\",\"NaN\",0.6241791036891872,0.08036579443177472,0.5965362535110407],[\"NaN\",0.28833886233719697,\"NaN\",0.42886510308433234,0.31938392736879495],[0.46737499165477336,0.29049804699145987,\"NaN\",\"NaN\",0.42613387216201437],[0.26921949544375223,\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",0.11388068499096815,0.8266264607378907,0.9568687808458498]]]],[4,[[[\"NaN\",0.7814842733466515,0.5135839914826525,\"NaN\",0.16073971449320879],[0.5607992869314798,0.7387991082268067,\"NaN\",0.05921868230727545,0.9842594977745243],[0.14952094825065965,0.12321841492798835,0.011434335782795957,\"NaN\",\"NaN\"],[0.049162809586385525,0.8651389243508589,\"NaN\",0.12046097097699782,0.142536323987152],[0.3511259687463071,\"NaN\",0.04299498849339267,\"NaN\",0.1512568889145457]],[[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.19895092143881354,0.8624504217208266,0.2279392887010836,\"NaN\"],[0.3071502534437418,\"NaN\",0.22355870553683355,0.7340281980602354,\"NaN\"],[0.5648273810673259,0.810673797273031,\"NaN\",\"NaN\",\"NaN\"],[0.38909091354648384,0.2530595486741565,\"NaN\",0.9507794229634469,\"NaN\"]],[[\"NaN\",\"NaN\",0.6547704868744159,\"NaN\",0.2511373699961519],[\"NaN\",\"NaN\",\"NaN\",0.2364595249442628,\"NaN\"],[0.9108904069079028,0.263914559087814,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",0.2767542583208733,0.6129686856147829,0.5852767076119066],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.8158098885050329]],[[0.12458992133789715,0.25583368605114953,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.12589181637333935,\"NaN\",\"NaN\",0.5634382422990614],[0.5750563893948818,\"NaN\",0.815283341836417,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.8100646037895952],[0.9459802886177806,0.80428910348174,\"NaN\",\"NaN\",0.9889792286599008]],[[\"NaN\",\"NaN\",\"NaN\",0.8959390653049583,\"NaN\"],[0.5781034257200561,\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.5349190153087392,\"NaN\",\"NaN\",0.8227289249548829],[\"NaN\",0.5271200233793667,\"NaN\",\"NaN\",0.47953070011238585],[\"NaN\",0.15104763959574607,0.7367398400384219,\"NaN\",\"NaN\"]],[[\"NaN\",\"NaN\",\"NaN\",0.6856672149907731,\"NaN\"],[0.678241862327311,\"NaN\",0.8845130759549505,0.05365307831376298,0.5117251131760897],[0.629757420270312,\"NaN\",\"NaN\",\"NaN\",0.791237230618021],[\"NaN\",\"NaN\",0.17559938114910933,0.6148602219093365,\"NaN\"],[0.46670176474156877,0.6190096823732661,\"NaN\",0.9656519836874577,\"NaN\"]]]],[5,[[[0.784285984404001,\"NaN\",0.38274078817001667,\"NaN\",0.8234382072034288],[0.44085252189489743,\"NaN\",\"NaN\",0.2776054528372862,\"NaN\"],[\"NaN\",\"NaN\",0.8069583125297918,\"NaN\",0.8564743429041859],[0.34033471189955766,\"NaN\",0.5847747234041284,0.828858661411984,\"NaN\"],[0.5970791752312621,\"NaN\",0.4001242945804977,0.13360911189597668,\"NaN\"]],[[\"NaN\",0.021126127284106677,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.7968216184939031,\"NaN\",\"NaN\",\"NaN\"],[0.9038601252939694,0.8166415687236853,0.015589148920726714,0.9602936937586225,\"NaN\"],[0.8058065613332571,\"NaN\",0.6173031606937746,0.32800871754074146,\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",0.342116256666128,\"NaN\"]],[[\"NaN\",0.6272214517031198,0.9911671887539112,0.2923645809786011,\"NaN\"],[0.7644683095949059,0.7603687808937638,0.8059175214751112,0.13599319076711602,\"NaN\"],[\"NaN\",\"NaN\",0.198834087623723,0.919538096179176,\"NaN\"],[\"NaN\",\"NaN\",0.312601350997162,0.9502758337309983,\"NaN\"],[\"NaN\",\"NaN\",0.21673613477834874,\"NaN\",\"NaN\"]],[[0.7985991394568994,0.28669835268072585,\"NaN\",0.03461941784584077,\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.5942971321734463],[0.5982523372971537,\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",0.28777076514591327,0.9268230533407369,\"NaN\"],[0.7044348132374062,\"NaN\",0.8810811690658492,\"NaN\",0.7456229564537246]],[[0.8373011153841059,\"NaN\",0.5648827814625057,\"NaN\",\"NaN\"],[\"NaN\",0.23342748472335595,0.3488623395557059,0.8943864531134549,\"NaN\"],[\"NaN\",\"NaN\",0.8190248739373566,\"NaN\",\"NaN\"],[0.299991661978634,0.24073627994072233,\"NaN\",\"NaN\",0.39167385218235884],[\"NaN\",0.792270957045652,\"NaN\",0.1957644622947874,\"NaN\"]],[[0.17159081696305678,0.9183900304520896,0.7414527381373733,\"NaN\",0.8348043933242438],[\"NaN\",\"NaN\",0.4999546826712882,\"NaN\",0.1263674390571341],[\"NaN\",0.46106114963600453,0.950357487757758,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.25881569507775415],[\"NaN\",0.11690518860255061,\"NaN\",0.17692096949785385,0.9509494891504509]]]],[6,[[[0.5774285411509287,0.0887077544556999,0.24055706940147548,0.27448691718016605,\"NaN\"],[\"NaN\",\"NaN\",0.10351327983544889,0.2845084389951953,\"NaN\"],[\"NaN\",0.9789031960785982,0.35924966985373885,\"NaN\",0.45348458715464957],[\"NaN\",0.9162468078866889,0.7632094061454662,0.038883509427327545,0.6292519544518277],[\"NaN\",\"NaN\",0.8134265518533048,0.18514183202528678,\"NaN\"]],[[0.12378538182698662,\"NaN\",\"NaN\",0.787194776072885,0.4748891862574217],[0.46631093573658333,\"NaN\",0.18832749308521224,0.09213937015354234,0.6766835108175027],[\"NaN\",0.6264663438366258,\"NaN\",0.4677761849862039,\"NaN\"],[\"NaN\",0.5730630096984864,0.17263182221253648,\"NaN\",0.08270680311814738],[\"NaN\",\"NaN\",\"NaN\",0.8866911582682019,0.429846962469978]],[[0.6191502950512981,\"NaN\",0.45200308286309054,\"NaN\",0.16988782988987772],[0.8216730867907212,\"NaN\",\"NaN\",0.5782831768526632,0.08649662527912216],[\"NaN\",0.7543243416468268,0.1916365767723497,\"NaN\",\"NaN\"],[\"NaN\",0.09271525373728084,0.886413126795241,0.45304925689131226,\"NaN\"],[0.5537893347481317,\"NaN\",0.232494195045592,0.5748181638370875,\"NaN\"]],[[0.5018219565304508,0.9622103096477237,0.26209311499443577,0.039553784290589755,\"NaN\"],[\"NaN\",0.934245825395921,\"NaN\",0.8928857962488065,0.4857275272419912],[\"NaN\",0.20669667996391494,0.3429167831531923,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.6918315199929271],[0.6835439437199142,0.8602341763527942,0.05988697500766238,\"NaN\",\"NaN\"]],[[0.21538897325133466,\"NaN\",\"NaN\",0.7618107826664764,\"NaN\"],[0.7862701559467499,0.04695757070165463,0.33230372401210906,\"NaN\",0.1319246654797882],[0.2019261679193095,\"NaN\",0.7889687660701813,0.38514030454873815,0.5717733549237713],[\"NaN\",\"NaN\",0.991309986656942,\"NaN\",0.7894929773807379],[\"NaN\",\"NaN\",\"NaN\",0.7969633519599547,0.8522462037814209]],[[\"NaN\",0.16200470722741211,\"NaN\",\"NaN\",0.19372261260065005],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.864125001324119],[0.9804796712313234,0.4717319886165221,0.3559983038791188,0.009393039740731468,\"NaN\"],[\"NaN\",\"NaN\",0.6293875081034573,0.5718662900337274,0.44738383371151946],[\"NaN\",0.7090540254652102,0.9040361687448522,\"NaN\",\"NaN\"]]]],[7,[[[\"NaN\",0.8848630259368752,0.4986245972393514,\"NaN\",0.14177968047635847],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.683667681892418],[\"NaN\",0.8801227468993204,\"NaN\",\"NaN\",0.516387387929509],[\"NaN\",0.4086372745251967,0.7236745874854895,0.47368861397482487,0.011722647212085047],[\"NaN\",0.38808309318234757,0.754263906317381,0.07595341518164056,0.49998713304459175]],[[0.7752245588769471,0.7016289572025548,\"NaN\",\"NaN\",\"NaN\"],[0.3147068858848615,0.6908873001028643,\"NaN\",0.49179135461890966,\"NaN\"],[0.08604477197869931,0.5493171822418179,6.442391466067177E-4,0.6096957179171991,0.4706297532336319],[0.4014266653674814,\"NaN\",0.7894697992619679,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.26661128329478434]],[[\"NaN\",0.09864489903337492,0.11026719626473658,0.20556362074883205,\"NaN\"],[0.34774887231771323,\"NaN\",\"NaN\",0.7448050307848432,0.6597397021058683],[0.32035204680276474,0.6489306866155524,0.042984788359244686,0.5318955672582726,\"NaN\"],[\"NaN\",0.5679894801972694,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",0.903584465726624,\"NaN\",0.1701427542219306]],[[0.2647814447391055,0.09943911957540452,\"NaN\",\"NaN\",\"NaN\"],[0.3926560358841724,0.1796504141330968,0.8884366088170247,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[0.9948187434951518,0.6069328203593404,\"NaN\",\"NaN\",\"NaN\"],[0.36307263617448216,\"NaN\",0.8995857016357705,\"NaN\",\"NaN\"]],[[0.8009894533007684,\"NaN\",\"NaN\",0.7812695434155427,0.0717008124737567],[0.6905953150027988,\"NaN\",0.2750118844746253,\"NaN\",0.9384953620345644],[\"NaN\",0.9144100063950892,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",0.8075223893487803,\"NaN\"],[0.1539351434880245,\"NaN\",0.6170537034783615,0.047116579198476005,0.42873121201229347]],[[\"NaN\",0.6990292059022133,\"NaN\",0.885574229829795,0.6633175958823747],[\"NaN\",\"NaN\",\"NaN\",0.21743566558703487,\"NaN\"],[\"NaN\",0.3295034250444032,\"NaN\",0.741783837335665,0.4031162553175356],[0.09127962513584176,0.3623933201688526,\"NaN\",0.6845967697328093,0.8133670468553458],[0.31301748178720556,0.8780235160024262,0.8331271937293756,0.3000373722485714,0.8825929863748452]]]],[8,[[[0.5893913488864103,0.10434464385657194,0.2103189714974214,0.20733512325569314,\"NaN\"],[\"NaN\",\"NaN\",0.6786698028243686,0.1562735702503244,\"NaN\"],[0.01845094170262762,\"NaN\",0.7840422340367178,\"NaN\",\"NaN\"],[0.20392939678329325,0.03126363050612857,0.545649637637243,0.1366962178370018,0.9158592318648939],[\"NaN\",\"NaN\",0.37229032792010053,0.7010947326066482,0.6653558105852869]],[[\"NaN\",0.4479922983434197,0.17747464319338369,0.578848986726831,\"NaN\"],[0.9219773150523086,0.8745895318581147,\"NaN\",0.15907967377340315,0.09856553943490398],[0.4310850847643303,\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[0.0904275851204015,0.09813405810748643,\"NaN\",\"NaN\",0.16637919254647626],[0.6358618401380665,0.8250745656063094,0.08786353020047166,0.6504187518518438,0.6656684457983135]],[[\"NaN\",\"NaN\",\"NaN\",0.9691253961065744,\"NaN\"],[0.2810121927708944,\"NaN\",0.03573395237731902,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[0.5269653816462402,\"NaN\",\"NaN\",0.7197602191055252,\"NaN\"],[0.7293293848084196,0.4471489260796604,\"NaN\",\"NaN\",0.7983813764733022]],[[\"NaN\",\"NaN\",\"NaN\",0.17951895279764385,0.6879240781860073],[\"NaN\",\"NaN\",\"NaN\",0.9421356116658606,0.9622026654998326],[0.7232976493821398,\"NaN\",0.46734153770764575,0.6059304956805995,0.5740767909043064],[\"NaN\",0.638211748349872,0.6687393410124027,\"NaN\",\"NaN\"],[0.9039701427954507,\"NaN\",0.7146729387016028,0.8035468722105662,0.21495009083611682]],[[\"NaN\",0.025093901145949116,0.8017862666077649,0.889040084162395,\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.8076633026986578,0.9632290185610527,0.6989717762416783,\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",0.8459833677971516,\"NaN\"],[\"NaN\",\"NaN\",0.9583118050858839,0.7597383502291719,\"NaN\"]],[[0.6002200984955043,0.2705004237511053,0.05060878777178268,\"NaN\",0.7634383634101563],[\"NaN\",0.26331831906128744,0.4535538030590146,\"NaN\",\"NaN\"],[0.2547154650902098,\"NaN\",\"NaN\",0.055472027832835114,0.6303797085357445],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.7846380012946819,0.19770375787188899,\"NaN\",\"NaN\"]]]],[9,[[[\"NaN\",0.8092413086745978,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.8801924839622193,0.5070157934058923,\"NaN\",\"NaN\"],[0.2374338858065208,0.3098865397799132,0.723535516745248,0.8676065099920102,0.6909004691903089],[0.6596896749571384,\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[0.7762532810743196,0.5110409721347505,\"NaN\",\"NaN\",0.3402715765540666]],[[0.5168149468636793,0.05956224325035331,\"NaN\",\"NaN\",\"NaN\"],[\"NaN\",0.7015077355100362,\"NaN\",\"NaN\",0.23084967334069773],[\"NaN\",\"NaN\",\"NaN\",0.6361137291411072,\"NaN\"],[\"NaN\",0.8684152452927467,0.9154454136669807,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.48725551014278157]],[[\"NaN\",0.9987400714239923,\"NaN\",\"NaN\",0.7664162423173838],[0.06820698131254666,0.06350691099631212,0.6089223773205642,0.27472846335547607,0.8172643429511735],[0.6822751626595059,0.5049192970012601,\"NaN\",0.24474566109231677,\"NaN\"],[0.26775629195628736,\"NaN\",0.7160168968224614,\"NaN\",\"NaN\"],[\"NaN\",0.6556239372889717,0.6035369527258297,0.007816174657109931,0.15767248880821827]],[[\"NaN\",\"NaN\",0.7087959523378354,0.701855506498224,0.35280939127919697],[\"NaN\",0.377754755897864,0.6194434975011099,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",\"NaN\",0.32789323530722403,\"NaN\"],[\"NaN\",\"NaN\",2.7051722329241024E-4,\"NaN\",\"NaN\"],[0.3670970262060833,0.35818888462825316,0.547922608338187,0.4120667629886985,\"NaN\"]],[[0.30301453636770925,0.1736971292050472,0.15728441992982933,\"NaN\",\"NaN\"],[\"NaN\",0.697513139756686,0.7462566234664488,0.2906806564310356,0.9117323098948511],[\"NaN\",0.9728870966561209,0.8434055907091542,\"NaN\",\"NaN\"],[\"NaN\",0.1311064691671595,0.02306917111894302,\"NaN\",\"NaN\"],[\"NaN\",\"NaN\",0.7318482354701378,\"NaN\",0.19045729367687536]],[[0.4832408014399082,0.5110051097421732,0.8602516923533683,\"NaN\",0.9895316676447785],[0.948844849755593,\"NaN\",0.8621336618372217,0.45781590958775376,0.2788934979737281],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[0.7007497788003791,0.14936270753912462,\"NaN\",0.790117027326527,\"NaN\"],[\"NaN\",0.48962223694989393,\"NaN\",0.971069572186699,\"NaN\"]]]],[10,[[[\"NaN\",0.30003375789732,\"NaN\",\"NaN\",\"NaN\"],[0.8190040152319173,0.432005267438173,\"NaN\",0.05078484325276578,\"NaN\"],[0.4293260071373979,0.6178831373192377,0.16435698591872727,\"NaN\",\"NaN\"],[\"NaN\",0.289196195667174,0.3626344051478466,0.8999240255472278,0.4491038082051957],[\"NaN\",\"NaN\",0.6980331067527935,0.26892201063375765,0.1431421117284598]],[[\"NaN\",\"NaN\",0.4160327955244305,0.33905449992701286,\"NaN\"],[0.07328594734203964,\"NaN\",0.8667019339484177,\"NaN\",\"NaN\"],[0.8028919501439555,0.4666883417655623,0.20230827732012568,0.8048774763603137,0.8160134802077901],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"],[0.778635927662033,\"NaN\",0.53932171877341,\"NaN\",\"NaN\"]],[[0.10504992500308863,\"NaN\",\"NaN\",0.6540895368909402,\"NaN\"],[0.3969020523175171,0.3060002339722535,\"NaN\",0.5468549268360259,0.7597260921872426],[\"NaN\",0.4554699242413789,0.5066968105061035,0.27675892538344127,0.5766629614226516],[0.43813899410578816,\"NaN\",0.7408898251726689,0.9978358000543871,0.10049083182396945],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",0.11202636077148465]],[[0.6587381976382575,\"NaN\",0.1632093830334005,0.45191988805750405,0.05762171148590178],[\"NaN\",\"NaN\",0.7372823438419662,\"NaN\",\"NaN\"],[0.4691808420056377,\"NaN\",0.9293199965149462,\"NaN\",0.3102342746394352],[0.9305113350251463,0.8836553101213755,0.1104822941679171,\"NaN\",0.6712969740357905],[\"NaN\",\"NaN\",\"NaN\",\"NaN\",\"NaN\"]],[[\"NaN\",\"NaN\",0.20584203596546957,\"NaN\",\"NaN\"],[0.4219687337945647,\"NaN\",\"NaN\",0.7605628070230319,0.9979677987238988],[\"NaN\",0.9899205411396946,\"NaN\",\"NaN\",0.2019494078970604],[\"NaN\",\"NaN\",0.2279599406169569,\"NaN\",\"NaN\"],[0.4444342589712791,0.53298954677709,\"NaN\",\"NaN\",0.314267447476294]],[[0.4648302690084546,\"NaN\",0.8696975132617628,\"NaN\",0.3291540826057757],[\"NaN\",0.05207459508454415,\"NaN\",0.8455408845738817,0.19342098331542135],[0.3140804401593966,0.9057733500204002,0.8152292448707714,0.7522046387561664,\"NaN\"],[\"NaN\",0.8237294003961838,\"NaN\",\"NaN\",\"NaN\"],[0.006092519264875196,\"NaN\",0.7017896045980857,0.7240943454588068,0.7401907917444734]]]]],\"count\":10}",
                                    // It is important that the array is not the first column, there is ',' state that has to be dealt with.
                                    // It is also important that other columns in the select statement are not "rnd", this is due to the
                                    // fact that column value is re-requested from the record in case it could not be sent due to
                                    // send buffer being full. Array values are cached in the state, they are not re-requested from the record,
                                    // whereas every primitive value is re-requested, and it moves the random seeds.
                                    "select x i, rnd_double_array(3, 1, 0, 6, 5, 5) a from long_sequence(10);"
                            );
                        }
                    });
        });
    }

    @Test
    public void testTextHttp() throws Exception {
        var rnd = TestUtils.generateRandom(LOG);
        TestUtils.assertMemoryLeak(() -> {
            HttpServerConfigurationBuilder httpServerConfigurationBuilder = new HttpServerConfigurationBuilder();
            httpServerConfigurationBuilder.withSendBufferSize(Math.max(384, rnd.nextInt(2048)));
            new HttpQueryTestBuilder()
                    .withTempFolder(root)
                    .withWorkerCount(1)
                    .withHttpServerConfigBuilder(httpServerConfigurationBuilder)
                    .withTelemetry(false).run(configuration, (engine, sqlExecutionContext) -> {
                        try (TestHttpClient testHttpClient = new TestHttpClient()) {
                            // It is important that the array is not the first column, there is ',' state that has to be
                            // dealt with. It is also important that other columns in the select statement are not
                            // "rnd", this is due to the fact that column value is re-requested from the record in case
                            // it could not be sent due to send buffer being full. Array values are cached in the state,
                            // they are not re-requested from the record, whereas every primitive value is re-requested,
                            // and it moves the random seeds.
                            testHttpClient.assertGet(
                                    "/exp",
                                    "\"i\",\"a\"\r\n" +
                                            "1,\"[[[3.140643285813871E-4,0.69326537621448,null,0.28611020049545155,null],[null,null,0.5395556701065334,0.1414022742755634,null],[0.4752350123164646,0.6012657989910146,null,0.585843770955637,null],[null,null,null,0.40606013316388134,null],[null,null,null,null,null]],[[null,null,null,0.5991208536973013,null],[0.9871985652253371,null,0.18913032301894672,null,0.3000363025683642],[0.43616277818500915,0.08657222778592621,0.14893292888311582,0.21270770921920534,0.5608015822958148],[null,0.6319160111413077,null,null,0.5811707053522398],[0.6201771582888651,0.8063107890584933,null,null,0.15558156333753415]],[[0.9360481563399781,0.4427989924185698,null,null,null],[0.6338323241897774,0.8363524710257856,null,0.2801838877829529,0.011505636475178882],[0.11516578622333529,null,0.5455556321733311,0.9001351934403463,0.1077875767567732],[null,0.9267643777579697,0.9721119491190986,null,0.35964115008734654],[0.42562822640930975,null,0.2529188867293015,null,0.5309250101098157]],[[null,0.784319824158902,0.9332198681153373,0.23900556474173051,null],[0.9847596838028854,0.5936397607121807,null,null,null],[null,null,0.30458754305760216,null,0.7382439636961146],[null,null,null,null,null],[0.028023202541271552,null,null,null,null]],[[0.2550987399566025,0.26998063364754565,0.48553627411000255,null,null],[0.9149475104319955,0.34010418384031016,0.33067919657781575,0.2991619325507572,null],[null,0.14508948012827227,0.5471104536442293,null,null],[0.39133262243846456,0.14939745795088222,null,0.2834693915481332,0.4667925424641276],[null,0.6100098794868637,null,0.9978847217852047,0.9087973139283032]],[[null,0.6729332686036003,0.3136394834603561,0.32051007905454854,0.24847919277865826],[null,null,0.4170561750437699,null,0.5077538022340554],[null,null,0.33054550160950924,0.9852757658028125,0.42075355831328076],[0.5589479147681313,0.01698255462610221,0.004173800793017768,null,0.21500439422034878],[0.3343834474562737,0.5802903532666576,0.36021288429451503,0.5232435236521195,0.6241404240587153]]]\"\r\n" +
                                            "2,\"[[[null,0.3625739584222255,null,null,0.8715957334272174],[null,0.6981204218210215,null,null,0.4789079242814711],[null,null,null,null,0.4657235232836129],[null,null,null,null,0.4925290165795897],[0.2845729124745331,null,null,0.5600938003214948,null]],[[null,0.5110349447094176,0.7609549086216094,0.712426440067183,null],[0.5196476350387685,0.809222446377486,0.19085246561089975,null,null],[0.1258282732241729,null,0.11325766135215543,null,null],[0.6328443358620268,null,0.6814372353820676,0.30291527029628107,0.06160478275027348],[0.49990090684101296,null,null,0.13230031112011953,0.5899978129923895]],[[null,0.663127231109937,0.7918446314679398,null,null],[0.5106730538390831,0.5020685834316602,0.4088852574680012,0.5857925358362319,0.9969836895471604],[null,null,null,0.22374362908836276,0.6327157066881115],[null,null,null,null,0.9334413940165974],[0.5080514829400804,0.4592718298298374,null,null,null]],[[0.45390337504345846,0.5080689995125803,0.49344546021927094,0.10397147831405107,null],[0.14898060387981882,null,null,0.4844601167172399,null],[0.824076010336407,null,null,0.39176662665084594,null],[null,0.1840786233366638,null,0.0222576440125547,0.14094076327022687],[0.6181874980917226,0.7082847456484765,null,null,null]],[[0.6161402197064566,null,0.3478570816173613,0.8258372156546406,null],[0.9675876829379909,0.7020491711331152,null,0.9276633302839218,null],[null,0.9019633479004099,0.036511800576904396,0.4137763602532154,0.4530084570382452],[0.01733741552691881,null,null,0.08128765779919345,null],[0.22450260293050006,null,null,0.947648217247076,0.5150255333301709]],[[0.09862030224478213,0.5792866960913927,null,0.9020516321848266,0.9418375788143808],[0.013581540669556524,null,null,0.5521983891704567,0.3345830183347629],[0.11278012801599668,null,0.41526333342641597,0.46715795851277564,0.08205243298844189],[0.9143831813584994,0.5869710656363932,null,null,null],[0.14141030145763844,0.4616806226805663,null,null,null]]]\"\r\n" +
                                            "3,\"[[[null,0.7441762142201299,null,0.9007685633526413,null],[null,0.09870621758114917,null,null,0.5212800926402809],[null,null,0.2665147189066862,null,0.6596016325018639],[null,null,null,null,0.3289865899620855],[null,null,null,0.6947608978601755,null]],[[0.35295079323045075,0.17827118615542348,null,0.7353499602569634,0.9937226635851747],[0.6467408377797746,null,null,0.015471125917476458,null],[0.6873870516177227,null,0.8108831679925128,0.5672618974103468,0.18142244552049425],[0.9653350589425297,0.6907773125478485,0.49704803890433114,0.9988072081672303,null],[null,0.7548788608971204,0.7025981871298874,0.1873572115879738,0.3876649534979676]],[[0.8889347281597823,null,0.3677284485126112,null,null],[0.2713629319580093,null,0.22487682684834898,0.9247914156115961,null],[null,0.13047900616491237,null,0.7907367407608518,null],[0.35415409494351,0.03126813961360764,0.2446165709405037,null,null],[0.30864730519143946,null,0.9802235708350467,0.4967594942625583,0.16811223457711422]],[[null,null,0.816199041941703,0.22124517201539007,null],[null,null,0.9341747148492238,null,null],[null,null,0.8020514273264906,null,0.8804206933491007],[null,0.0012498640366348512,0.07498503244627697,0.5375592327504564,null],[null,0.6194294357020026,null,null,0.6646355825030826]],[[0.4792215863147231,0.9895478229929195,null,null,0.43263940239144116],[0.6797218754063832,null,0.10190699880145715,0.6281158131097979,null],[0.22557349725908127,0.5687027619533433,0.893977719461526,0.31828902314670326,0.2791260274882422],[null,0.9444113594020382,0.21710217143333221,0.10850424938817349,null],[0.36363266360706703,null,0.5768695267498187,null,null]],[[null,null,0.6241791036891872,0.08036579443177472,0.5965362535110407],[null,0.28833886233719697,null,0.42886510308433234,0.31938392736879495],[0.46737499165477336,0.29049804699145987,null,null,0.42613387216201437],[0.26921949544375223,null,null,null,null],[null,null,0.11388068499096815,0.8266264607378907,0.9568687808458498]]]\"\r\n" +
                                            "4,\"[[[null,0.7814842733466515,0.5135839914826525,null,0.16073971449320879],[0.5607992869314798,0.7387991082268067,null,0.05921868230727545,0.9842594977745243],[0.14952094825065965,0.12321841492798835,0.011434335782795957,null,null],[0.049162809586385525,0.8651389243508589,null,0.12046097097699782,0.142536323987152],[0.3511259687463071,null,0.04299498849339267,null,0.1512568889145457]],[[null,null,null,null,null],[null,0.19895092143881354,0.8624504217208266,0.2279392887010836,null],[0.3071502534437418,null,0.22355870553683355,0.7340281980602354,null],[0.5648273810673259,0.810673797273031,null,null,null],[0.38909091354648384,0.2530595486741565,null,0.9507794229634469,null]],[[null,null,0.6547704868744159,null,0.2511373699961519],[null,null,null,0.2364595249442628,null],[0.9108904069079028,0.263914559087814,null,null,null],[null,null,0.2767542583208733,0.6129686856147829,0.5852767076119066],[null,null,null,null,0.8158098885050329]],[[0.12458992133789715,0.25583368605114953,null,null,null],[null,0.12589181637333935,null,null,0.5634382422990614],[0.5750563893948818,null,0.815283341836417,null,null],[null,null,null,null,0.8100646037895952],[0.9459802886177806,0.80428910348174,null,null,0.9889792286599008]],[[null,null,null,0.8959390653049583,null],[0.5781034257200561,null,null,null,null],[null,0.5349190153087392,null,null,0.8227289249548829],[null,0.5271200233793667,null,null,0.47953070011238585],[null,0.15104763959574607,0.7367398400384219,null,null]],[[null,null,null,0.6856672149907731,null],[0.678241862327311,null,0.8845130759549505,0.05365307831376298,0.5117251131760897],[0.629757420270312,null,null,null,0.791237230618021],[null,null,0.17559938114910933,0.6148602219093365,null],[0.46670176474156877,0.6190096823732661,null,0.9656519836874577,null]]]\"\r\n" +
                                            "5,\"[[[0.784285984404001,null,0.38274078817001667,null,0.8234382072034288],[0.44085252189489743,null,null,0.2776054528372862,null],[null,null,0.8069583125297918,null,0.8564743429041859],[0.34033471189955766,null,0.5847747234041284,0.828858661411984,null],[0.5970791752312621,null,0.4001242945804977,0.13360911189597668,null]],[[null,0.021126127284106677,null,null,null],[null,0.7968216184939031,null,null,null],[0.9038601252939694,0.8166415687236853,0.015589148920726714,0.9602936937586225,null],[0.8058065613332571,null,0.6173031606937746,0.32800871754074146,null],[null,null,null,0.342116256666128,null]],[[null,0.6272214517031198,0.9911671887539112,0.2923645809786011,null],[0.7644683095949059,0.7603687808937638,0.8059175214751112,0.13599319076711602,null],[null,null,0.198834087623723,0.919538096179176,null],[null,null,0.312601350997162,0.9502758337309983,null],[null,null,0.21673613477834874,null,null]],[[0.7985991394568994,0.28669835268072585,null,0.03461941784584077,null],[null,null,null,null,0.5942971321734463],[0.5982523372971537,null,null,null,null],[null,null,0.28777076514591327,0.9268230533407369,null],[0.7044348132374062,null,0.8810811690658492,null,0.7456229564537246]],[[0.8373011153841059,null,0.5648827814625057,null,null],[null,0.23342748472335595,0.3488623395557059,0.8943864531134549,null],[null,null,0.8190248739373566,null,null],[0.299991661978634,0.24073627994072233,null,null,0.39167385218235884],[null,0.792270957045652,null,0.1957644622947874,null]],[[0.17159081696305678,0.9183900304520896,0.7414527381373733,null,0.8348043933242438],[null,null,0.4999546826712882,null,0.1263674390571341],[null,0.46106114963600453,0.950357487757758,null,null],[null,null,null,null,0.25881569507775415],[null,0.11690518860255061,null,0.17692096949785385,0.9509494891504509]]]\"\r\n" +
                                            "6,\"[[[0.5774285411509287,0.0887077544556999,0.24055706940147548,0.27448691718016605,null],[null,null,0.10351327983544889,0.2845084389951953,null],[null,0.9789031960785982,0.35924966985373885,null,0.45348458715464957],[null,0.9162468078866889,0.7632094061454662,0.038883509427327545,0.6292519544518277],[null,null,0.8134265518533048,0.18514183202528678,null]],[[0.12378538182698662,null,null,0.787194776072885,0.4748891862574217],[0.46631093573658333,null,0.18832749308521224,0.09213937015354234,0.6766835108175027],[null,0.6264663438366258,null,0.4677761849862039,null],[null,0.5730630096984864,0.17263182221253648,null,0.08270680311814738],[null,null,null,0.8866911582682019,0.429846962469978]],[[0.6191502950512981,null,0.45200308286309054,null,0.16988782988987772],[0.8216730867907212,null,null,0.5782831768526632,0.08649662527912216],[null,0.7543243416468268,0.1916365767723497,null,null],[null,0.09271525373728084,0.886413126795241,0.45304925689131226,null],[0.5537893347481317,null,0.232494195045592,0.5748181638370875,null]],[[0.5018219565304508,0.9622103096477237,0.26209311499443577,0.039553784290589755,null],[null,0.934245825395921,null,0.8928857962488065,0.4857275272419912],[null,0.20669667996391494,0.3429167831531923,null,null],[null,null,null,null,0.6918315199929271],[0.6835439437199142,0.8602341763527942,0.05988697500766238,null,null]],[[0.21538897325133466,null,null,0.7618107826664764,null],[0.7862701559467499,0.04695757070165463,0.33230372401210906,null,0.1319246654797882],[0.2019261679193095,null,0.7889687660701813,0.38514030454873815,0.5717733549237713],[null,null,0.991309986656942,null,0.7894929773807379],[null,null,null,0.7969633519599547,0.8522462037814209]],[[null,0.16200470722741211,null,null,0.19372261260065005],[null,null,null,null,0.864125001324119],[0.9804796712313234,0.4717319886165221,0.3559983038791188,0.009393039740731468,null],[null,null,0.6293875081034573,0.5718662900337274,0.44738383371151946],[null,0.7090540254652102,0.9040361687448522,null,null]]]\"\r\n" +
                                            "7,\"[[[null,0.8848630259368752,0.4986245972393514,null,0.14177968047635847],[null,null,null,null,0.683667681892418],[null,0.8801227468993204,null,null,0.516387387929509],[null,0.4086372745251967,0.7236745874854895,0.47368861397482487,0.011722647212085047],[null,0.38808309318234757,0.754263906317381,0.07595341518164056,0.49998713304459175]],[[0.7752245588769471,0.7016289572025548,null,null,null],[0.3147068858848615,0.6908873001028643,null,0.49179135461890966,null],[0.08604477197869931,0.5493171822418179,6.442391466067177E-4,0.6096957179171991,0.4706297532336319],[0.4014266653674814,null,0.7894697992619679,null,null],[null,null,null,null,0.26661128329478434]],[[null,0.09864489903337492,0.11026719626473658,0.20556362074883205,null],[0.34774887231771323,null,null,0.7448050307848432,0.6597397021058683],[0.32035204680276474,0.6489306866155524,0.042984788359244686,0.5318955672582726,null],[null,0.5679894801972694,null,null,null],[null,null,0.903584465726624,null,0.1701427542219306]],[[0.2647814447391055,0.09943911957540452,null,null,null],[0.3926560358841724,0.1796504141330968,0.8884366088170247,null,null],[null,null,null,null,null],[0.9948187434951518,0.6069328203593404,null,null,null],[0.36307263617448216,null,0.8995857016357705,null,null]],[[0.8009894533007684,null,null,0.7812695434155427,0.0717008124737567],[0.6905953150027988,null,0.2750118844746253,null,0.9384953620345644],[null,0.9144100063950892,null,null,null],[null,null,null,0.8075223893487803,null],[0.1539351434880245,null,0.6170537034783615,0.047116579198476005,0.42873121201229347]],[[null,0.6990292059022133,null,0.885574229829795,0.6633175958823747],[null,null,null,0.21743566558703487,null],[null,0.3295034250444032,null,0.741783837335665,0.4031162553175356],[0.09127962513584176,0.3623933201688526,null,0.6845967697328093,0.8133670468553458],[0.31301748178720556,0.8780235160024262,0.8331271937293756,0.3000373722485714,0.8825929863748452]]]\"\r\n" +
                                            "8,\"[[[0.5893913488864103,0.10434464385657194,0.2103189714974214,0.20733512325569314,null],[null,null,0.6786698028243686,0.1562735702503244,null],[0.01845094170262762,null,0.7840422340367178,null,null],[0.20392939678329325,0.03126363050612857,0.545649637637243,0.1366962178370018,0.9158592318648939],[null,null,0.37229032792010053,0.7010947326066482,0.6653558105852869]],[[null,0.4479922983434197,0.17747464319338369,0.578848986726831,null],[0.9219773150523086,0.8745895318581147,null,0.15907967377340315,0.09856553943490398],[0.4310850847643303,null,null,null,null],[0.0904275851204015,0.09813405810748643,null,null,0.16637919254647626],[0.6358618401380665,0.8250745656063094,0.08786353020047166,0.6504187518518438,0.6656684457983135]],[[null,null,null,0.9691253961065744,null],[0.2810121927708944,null,0.03573395237731902,null,null],[null,null,null,null,null],[0.5269653816462402,null,null,0.7197602191055252,null],[0.7293293848084196,0.4471489260796604,null,null,0.7983813764733022]],[[null,null,null,0.17951895279764385,0.6879240781860073],[null,null,null,0.9421356116658606,0.9622026654998326],[0.7232976493821398,null,0.46734153770764575,0.6059304956805995,0.5740767909043064],[null,0.638211748349872,0.6687393410124027,null,null],[0.9039701427954507,null,0.7146729387016028,0.8035468722105662,0.21495009083611682]],[[null,0.025093901145949116,0.8017862666077649,0.889040084162395,null],[null,null,null,null,null],[null,0.8076633026986578,0.9632290185610527,0.6989717762416783,null],[null,null,null,0.8459833677971516,null],[null,null,0.9583118050858839,0.7597383502291719,null]],[[0.6002200984955043,0.2705004237511053,0.05060878777178268,null,0.7634383634101563],[null,0.26331831906128744,0.4535538030590146,null,null],[0.2547154650902098,null,null,0.055472027832835114,0.6303797085357445],[null,null,null,null,null],[null,0.7846380012946819,0.19770375787188899,null,null]]]\"\r\n" +
                                            "9,\"[[[null,0.8092413086745978,null,null,null],[null,0.8801924839622193,0.5070157934058923,null,null],[0.2374338858065208,0.3098865397799132,0.723535516745248,0.8676065099920102,0.6909004691903089],[0.6596896749571384,null,null,null,null],[0.7762532810743196,0.5110409721347505,null,null,0.3402715765540666]],[[0.5168149468636793,0.05956224325035331,null,null,null],[null,0.7015077355100362,null,null,0.23084967334069773],[null,null,null,0.6361137291411072,null],[null,0.8684152452927467,0.9154454136669807,null,null],[null,null,null,null,0.48725551014278157]],[[null,0.9987400714239923,null,null,0.7664162423173838],[0.06820698131254666,0.06350691099631212,0.6089223773205642,0.27472846335547607,0.8172643429511735],[0.6822751626595059,0.5049192970012601,null,0.24474566109231677,null],[0.26775629195628736,null,0.7160168968224614,null,null],[null,0.6556239372889717,0.6035369527258297,0.007816174657109931,0.15767248880821827]],[[null,null,0.7087959523378354,0.701855506498224,0.35280939127919697],[null,0.377754755897864,0.6194434975011099,null,null],[null,null,null,0.32789323530722403,null],[null,null,2.7051722329241024E-4,null,null],[0.3670970262060833,0.35818888462825316,0.547922608338187,0.4120667629886985,null]],[[0.30301453636770925,0.1736971292050472,0.15728441992982933,null,null],[null,0.697513139756686,0.7462566234664488,0.2906806564310356,0.9117323098948511],[null,0.9728870966561209,0.8434055907091542,null,null],[null,0.1311064691671595,0.02306917111894302,null,null],[null,null,0.7318482354701378,null,0.19045729367687536]],[[0.4832408014399082,0.5110051097421732,0.8602516923533683,null,0.9895316676447785],[0.948844849755593,null,0.8621336618372217,0.45781590958775376,0.2788934979737281],[null,null,null,null,null],[0.7007497788003791,0.14936270753912462,null,0.790117027326527,null],[null,0.48962223694989393,null,0.971069572186699,null]]]\"\r\n" +
                                            "10,\"[[[null,0.30003375789732,null,null,null],[0.8190040152319173,0.432005267438173,null,0.05078484325276578,null],[0.4293260071373979,0.6178831373192377,0.16435698591872727,null,null],[null,0.289196195667174,0.3626344051478466,0.8999240255472278,0.4491038082051957],[null,null,0.6980331067527935,0.26892201063375765,0.1431421117284598]],[[null,null,0.4160327955244305,0.33905449992701286,null],[0.07328594734203964,null,0.8667019339484177,null,null],[0.8028919501439555,0.4666883417655623,0.20230827732012568,0.8048774763603137,0.8160134802077901],[null,null,null,null,null],[0.778635927662033,null,0.53932171877341,null,null]],[[0.10504992500308863,null,null,0.6540895368909402,null],[0.3969020523175171,0.3060002339722535,null,0.5468549268360259,0.7597260921872426],[null,0.4554699242413789,0.5066968105061035,0.27675892538344127,0.5766629614226516],[0.43813899410578816,null,0.7408898251726689,0.9978358000543871,0.10049083182396945],[null,null,null,null,0.11202636077148465]],[[0.6587381976382575,null,0.1632093830334005,0.45191988805750405,0.05762171148590178],[null,null,0.7372823438419662,null,null],[0.4691808420056377,null,0.9293199965149462,null,0.3102342746394352],[0.9305113350251463,0.8836553101213755,0.1104822941679171,null,0.6712969740357905],[null,null,null,null,null]],[[null,null,0.20584203596546957,null,null],[0.4219687337945647,null,null,0.7605628070230319,0.9979677987238988],[null,0.9899205411396946,null,null,0.2019494078970604],[null,null,0.2279599406169569,null,null],[0.4444342589712791,0.53298954677709,null,null,0.314267447476294]],[[0.4648302690084546,null,0.8696975132617628,null,0.3291540826057757],[null,0.05207459508454415,null,0.8455408845738817,0.19342098331542135],[0.3140804401593966,0.9057733500204002,0.8152292448707714,0.7522046387561664,null],[null,0.8237294003961838,null,null,null],[0.006092519264875196,null,0.7017896045980857,0.7240943454588068,0.7401907917444734]]]\"\r\n",
                                    "select x i, rnd_double_array(3, 1, 0, 6, 5, 5) a from long_sequence(10);",
                                    null,
                                    null
                            );
                        }
                    });
        });
    }

    @Ignore
    @Test
    public void testTextHttpWithNonVanilla() throws Exception {
        var rnd = TestUtils.generateRandom(LOG);
        TestUtils.assertMemoryLeak(() -> {
            HttpServerConfigurationBuilder httpServerConfigurationBuilder = new HttpServerConfigurationBuilder();
            httpServerConfigurationBuilder.withSendBufferSize(Math.max(384, rnd.nextInt(2048)));
            new HttpQueryTestBuilder()
                    .withTempFolder(root)
                    .withWorkerCount(1)
                    .withHttpServerConfigBuilder(httpServerConfigurationBuilder)
                    .withTelemetry(false).run(configuration, (engine, sqlExecutionContext) -> {
                        try (TestHttpClient testHttpClient = new TestHttpClient()) {
                            testHttpClient.assertGet(
                                    "/exp",
                                    "arr\n[[1.0,3.0,5.0],[2.0,4.0,6.0]]",
                                    "select transpose(ARRAY[[1.0,2],[3,4],[5,6]]) arr from long_sequence(1)"
                            );
                        }
                    });
        });
    }
}
